# Дашборд чатов с AI-саммари

**Дата:** 2025-12-02
**Статус:** Утверждён

## Обзор

Веб-дашборд на русском языке для мониторинга групповых чатов с возможностью получения AI-саммари за последние сутки.

**Пользователь:** личный инструмент
**Подход:** Синхронный MVP (Вариант A)
**Фронтенд:** HTML + Jinja2 + CSS (навык frontend-design)

## Архитектура

```
┌─────────────────────────────────────────────────┐
│                  Web Dashboard                   │
│  (HTML + Jinja2 + CSS, навык frontend-design)   │
└─────────────────┬───────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────┐
│              aiohttp Backend                     │
│  - GET /dashboard      → главная страница        │
│  - GET /api/dashboard  → JSON со статистикой     │
│  - POST /api/summary   → запрос саммари к LLM    │
└─────────────────┬───────────────────────────────┘
                  │
      ┌───────────┴───────────┐
      ▼                       ▼
┌───────────┐          ┌─────────────┐
│ PostgreSQL │          │ OpenRouter  │
│  (данные)  │          │   (LLM)     │
└───────────┘          └─────────────┘
```

## Новые файлы

- `app/web/dashboard.py` — роуты дашборда
- `app/services/summary.py` — сервис генерации саммари
- `app/services/openrouter.py` — клиент OpenRouter API
- `templates/dashboard.html` — шаблон страницы

## Конфигурация

Новые env-переменные:
- `OPENROUTER_API_KEY` — ключ API OpenRouter
- `OPENROUTER_MODEL` — модель (по умолчанию `openai/gpt-4o-mini`)

## Дашборд — данные

Для каждого чата показываем:
- Название чата
- Общее количество сообщений
- Количество сообщений за сегодня
- Последнее сообщение (текст, автор, время)
- Топ-3 активных участников за неделю (имя + количество)
- Кнопка "Получить саммари за сутки"

## API эндпоинты

### GET /api/dashboard

```json
{
  "chats": [
    {
      "id": -1001234567890,
      "title": "Команда разработки",
      "total_messages": 847,
      "today_messages": 42,
      "last_message": {
        "text": "Готово, залил в прод",
        "author": "ivan",
        "sent_at": "2024-12-02T14:32:00Z"
      },
      "top_users_week": [
        {"username": "ivan", "count": 156},
        {"username": "anna", "count": 98},
        {"username": "max", "count": 67}
      ]
    }
  ]
}
```

### POST /api/chats/{chat_id}/summary

```json
{
  "chat_id": -1001234567890,
  "period": "2024-12-01T14:32:00Z — 2024-12-02T14:32:00Z",
  "messages_count": 42,
  "summary": "## Основные темы\n1. Деплой новой версии..."
}
```

## Генерация саммари

### Логика

1. Получаем `chat_id` из запроса
2. Достаём из БД все сообщения за последние 24 часа
3. Формируем промпт с контекстом
4. Отправляем в OpenRouter
5. Возвращаем результат

### Промпт

```
Ты — аналитик чатов. Проанализируй сообщения из группового чата за последние сутки.

Чат: {chat_title}
Период: {date_from} — {date_to}
Сообщений: {count}

Сообщения:
{messages}

Дай краткое саммари на русском языке:
1. Основные темы обсуждения (2-3 пункта)
2. Ключевые решения или договорённости (если есть)
3. Важные вопросы без ответа (если есть)

Будь лаконичен, максимум 200 слов.
```

### Формат сообщений

```
[14:32] @ivan: Готово, залил в прод
[14:35] @anna: Отлично, тестирую
```

### Ограничения

- Максимум 500 сообщений за раз
- Если больше — берём последние 500

## Обработка ошибок

| Ситуация | Поведение |
|----------|-----------|
| Нет сообщений за сутки | "Нет сообщений за последние 24 часа" |
| OpenRouter недоступен | "Сервис временно недоступен, попробуйте позже" |
| Таймаут LLM (>30 сек) | Отменяем запрос, показываем ошибку |
| Нет API ключа | Скрываем кнопку саммари, дашборд работает |

## Расширяемость

Архитектура готова к расширению:
- Проактивные уведомления → scheduler + Telegram notifications
- Аналитика тем → расширить промпт или отдельный эндпоинт
- Кэширование саммари → таблица `summaries` в БД
- Другие LLM → замена модели в конфиге

## Что НЕ входит в MVP

- Авторизация (используем существующий Basic Auth)
- История саммари
- Выбор периода (только 24 часа)
