# Аналитика чатов и контент-стратегия

**Дата:** 2025-12-02
**Статус:** Утверждён

## Обзор

Две новые фичи для страницы детального просмотра чата:
1. **Аналитика за неделю** — график сообщений по дням + AI-комментарий с интерпретацией
2. **Контент-стратегия** — полный AI-отчёт с анализом тем, рекомендациями и идеями

**Пользователь:** автор контента (каналы + группы)
**Подход:** Ленивая загрузка (Вариант A)
**Фронтенд:** HTML + Jinja2 + CSS (навык frontend-design)

## Архитектура

```
Страница чата (/chats/{chat_id})
├── Табы: [Сообщения] [Аналитика] [Стратегия]
│
├── Таб "Сообщения" (существующий)
│   └── Список сообщений с пагинацией
│
├── Таб "Аналитика" (новый)
│   ├── График: сообщения по дням (7 дней)
│   └── AI-комментарий (загружается при открытии таба)
│
└── Таб "Стратегия" (новый)
    ├── Выбор периода: [Неделя] [Месяц]
    └── Кнопка "Сгенерировать отчёт" → полный AI-анализ
```

## Новые компоненты

**Файлы:**
- `app/services/analytics.py` — расчёт метрик (сообщения по дням)
- `app/services/strategy.py` — промпт и логика контент-стратегии
- Шаблон `chat_detail.html` — добавляем табы

**API эндпоинты:**
- `GET /api/chats/{id}/analytics` — метрики + AI-комментарий
- `POST /api/chats/{id}/strategy` — генерация отчёта

**Логика для каналов vs групп:**
- Канал: анализируем посты автора + реакции/комменты подписчиков
- Группа: анализируем общую активность всех участников

## Таб "Аналитика"

### API GET /api/chats/{id}/analytics

```json
{
  "chat_type": "channel",
  "period": "2025-11-25 — 2025-12-02",
  "daily_messages": [
    {"date": "2025-11-26", "count": 12},
    {"date": "2025-11-27", "count": 8},
    {"date": "2025-11-28", "count": 23},
    {"date": "2025-11-29", "count": 5},
    {"date": "2025-11-30", "count": 3},
    {"date": "2025-12-01", "count": 18},
    {"date": "2025-12-02", "count": 7}
  ],
  "total": 76,
  "average": 10.9,
  "ai_comment": "Пик активности в четверг (23 сообщения)..."
}
```

### AI-промпт для комментария

```
Ты — аналитик активности чата. Дай краткий комментарий (2-3 предложения) по статистике сообщений за неделю.

Тип: {channel|group}
Период: {date_from} — {date_to}
Данные: {daily_messages}
Всего: {total}, среднее: {average}/день

Укажи:
- Где пики и спады
- Возможные причины (день недели, события)

Будь лаконичен, максимум 50 слов.
```

### Визуализация

Простой бар-чарт на CSS (без библиотек) — 7 столбиков с подписями дней.

## Таб "Стратегия"

### API POST /api/chats/{id}/strategy

Request:
```json
{"period": "week"}
```

Response:
```json
{
  "chat_type": "channel",
  "period": "week",
  "date_range": "2025-11-25 — 2025-12-02",
  "messages_analyzed": 76,
  "report": {
    "topics_analysis": "## Что зашло\n- Посты про X получили больше реакций...",
    "recommendations": "## Рекомендации\n- Больше постов в будни...",
    "content_ideas": "## Идеи для постов\n1. Тема Y — аудитория активно реагировала..."
  }
}
```

### AI-промпт для стратегии

```
Ты — контент-стратег. Проанализируй сообщения из {channel|группы} за {период}.

Чат: {title}
Тип: {channel|group}
Период: {date_range}
Сообщений: {count}

Сообщения:
{messages}

Дай отчёт на русском:

## Что зашло
- Какие темы вызвали больше активности/реакций (2-3 пункта)

## Рекомендации
- Что автору стоит делать больше/меньше (2-3 совета)

## Идеи для постов
- 3 конкретные идеи на основе интересов аудитории

Максимум 300 слов.
```

### Ограничения

- Максимум 500 сообщений за раз
- Если больше — берём последние 500

## Обработка ошибок

| Ситуация | Поведение |
|----------|-----------|
| Нет сообщений за неделю | "Нет данных за последние 7 дней" |
| Нет сообщений за месяц | "Нет данных за последний месяц" |
| OpenRouter недоступен | Показываем метрики без AI-комментария + ошибка |
| Таймаут LLM (>30 сек) | "Не удалось получить анализ, попробуйте позже" |
| Нет API ключа | Табы "Аналитика" и "Стратегия" скрыты |

## UI-состояния табов

- **Загрузка:** спиннер / "Анализирую..."
- **Успех:** контент
- **Ошибка:** сообщение + кнопка "Повторить"

## Что НЕ входит в MVP

- Кэширование отчётов (каждый раз генерируем заново)
- Экспорт в PDF/файл
- Сравнение периодов
- История отчётов
