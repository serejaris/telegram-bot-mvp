{% extends "base.html" %}

{% block title %}dashboard{% endblock %}

{% block head %}
<style>
    .dashboard-header {
        margin-bottom: 32px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
    }

    .dashboard-header h1::before {
        content: "$ ";
    }

    .dashboard-header .subtitle {
        color: var(--dim);
        font-size: 0.85em;
    }

    .chats-grid {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .chat-card {
        border: 1px solid var(--border);
        padding: 20px;
        transition: border-color 0.15s;
    }

    .chat-card:hover {
        border-color: var(--dim);
    }

    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }

    .chat-title {
        font-size: 1em;
        font-weight: 500;
        color: var(--fg);
        margin: 0;
    }

    .chat-title::before {
        content: "> ";
        color: var(--dim);
    }

    .chat-title a {
        color: inherit;
    }

    .chat-title a:hover {
        text-decoration: underline;
    }

    .chat-stats {
        display: flex;
        gap: 16px;
        font-size: 0.85em;
    }

    .stat-item {
        color: var(--dim);
    }

    .stat-item .stat-value {
        color: var(--fg);
        font-weight: 500;
    }

    .stat-item.today .stat-value {
        color: var(--fg);
    }

    .chat-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 16px;
    }

    @media (max-width: 768px) {
        .chat-content {
            grid-template-columns: 1fr;
        }
    }

    .section-box {
        padding: 12px;
        border: 1px solid var(--border);
    }

    .section-label {
        font-size: 0.75em;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
    }

    .last-message-text {
        font-size: 0.9em;
        color: var(--dim);
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .last-message-meta {
        margin-top: 8px;
        font-size: 0.8em;
        color: var(--muted);
    }

    .last-message-meta .author {
        color: var(--dim);
    }

    .top-users-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .top-user {
        display: flex;
        justify-content: space-between;
        font-size: 0.85em;
        padding: 4px 0;
    }

    .top-user-rank {
        color: var(--muted);
        width: 20px;
    }

    .top-user-name {
        flex: 1;
        color: var(--dim);
    }

    .top-user-count {
        color: var(--muted);
    }

    /* ─── API Section ─── */
    .api-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
    }

    .api-endpoints {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .api-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8em;
    }

    .api-method {
        width: 40px;
        color: var(--muted);
    }

    .api-method.get { color: var(--dim); }
    .api-method.post { color: var(--dim); }

    .api-path {
        flex: 1;
        color: var(--dim);
        font-size: 0.95em;
    }

    /* ─── Actions ─── */
    .chat-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
    }

    .summary-btn {
        font-family: var(--font);
        font-size: 0.85em;
        padding: 8px 16px;
        background: transparent;
        color: var(--dim);
        border: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.15s;
    }

    .summary-btn:hover:not(:disabled) {
        color: var(--fg);
        border-color: var(--fg);
    }

    .summary-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .summary-btn.loading {
        pointer-events: none;
    }

    .summary-btn .spinner {
        display: inline-block;
        width: 10px;
        height: 10px;
        border: 1px solid var(--muted);
        border-top-color: var(--fg);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 6px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .summary-result {
        margin-top: 16px;
        padding: 16px;
        border: 1px solid var(--border);
        display: none;
    }

    .summary-result.visible {
        display: block;
    }

    .summary-result-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
    }

    .summary-result-title {
        font-size: 0.75em;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .summary-result-meta {
        font-size: 0.75em;
        color: var(--muted);
    }

    .summary-result-content {
        font-size: 0.9em;
        line-height: 1.6;
        color: var(--dim);
        white-space: pre-wrap;
    }

    .summary-error {
        color: #ff6b6b;
        border-color: #ff6b6b;
    }

    .no-data {
        color: var(--muted);
        font-style: italic;
        font-size: 0.85em;
    }

    /* ─── Hover: content readability ─── */
    .chat-card:hover .last-message-text,
    .chat-card:hover .last-message-meta .author,
    .chat-card:hover .top-user-name {
        color: var(--fg);
        transition: color 0.15s;
    }

    .chat-card:hover .top-user-count {
        color: var(--dim);
        transition: color 0.15s;
    }

    /* ─── Download button ─── */
    .dl-btn {
        cursor: pointer;
        color: var(--dim);
        border: 1px solid var(--border);
        background: transparent;
        padding: 2px 6px;
        font-family: var(--font);
        font-size: 0.85em;
        transition: all 0.15s;
    }

    .dl-btn:hover {
        color: var(--fg);
        border-color: var(--fg);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>dashboard</h1>
    <div class="subtitle">-- chat monitoring</div>
</div>

{% if chats %}
<div class="chats-grid">
    {% for chat in chats %}
    <div class="chat-card" data-chat-id="{{ chat.id }}">
        <div class="chat-header">
            <h2 class="chat-title">
                <a href="/chats/{{ chat.id }}">{{ chat.title or 'chat_' ~ chat.id }}</a>
            </h2>
            <div class="chat-stats">
                <div class="stat-item">
                    total: <span class="stat-value">{{ chat.total_messages }}</span>
                </div>
                <div class="stat-item today">
                    today: <span class="stat-value">{{ chat.today_messages }}</span>
                </div>
            </div>
        </div>

        <div class="chat-content">
            <div class="section-box">
                <div class="section-label">last_message</div>
                {% if chat.last_message_text %}
                <div class="last-message-text">{{ chat.last_message_text[:150] }}{% if chat.last_message_text|length > 150 %}...{% endif %}</div>
                <div class="last-message-meta">
                    <span class="author">@{{ chat.last_message_author }}</span>
                    {{ chat.last_message_at.strftime('%d.%m %H:%M') if chat.last_message_at else '' }}
                </div>
                {% else %}
                <div class="no-data">no text messages</div>
                {% endif %}
            </div>

            <div class="section-box">
                <div class="section-label">top_week</div>
                {% if chat.top_users %}
                <div class="top-users-list">
                    {% for user in chat.top_users %}
                    <div class="top-user">
                        <span class="top-user-rank">{{ loop.index }}.</span>
                        <span class="top-user-name">@{{ user.name }}</span>
                        <span class="top-user-count">{{ user.count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data">no activity</div>
                {% endif %}
            </div>
        </div>

        <div class="api-section">
            <div class="section-label">api_endpoints</div>
            <div class="api-endpoints">
                <div class="api-row">
                    <span class="api-method get">GET</span>
                    <code class="api-path">/api/chats/{{ chat.id }}/messages</code>
                    <button class="copy-btn" onclick="copyToClipboard('/api/chats/{{ chat.id }}/messages', this)">[cp]</button>
                </div>
                <div class="api-row">
                    <span class="api-method get">GET</span>
                    <code class="api-path">/api/chats/{{ chat.id }}/messages/daily?date=YYYY-MM-DD</code>
                    <button class="copy-btn" onclick="copyToClipboard('/api/chats/{{ chat.id }}/messages/daily?date=', this)">[cp]</button>
                </div>
                <div class="api-row">
                    <span class="api-method post">POST</span>
                    <code class="api-path">/api/chats/{{ chat.id }}/summary</code>
                    <button class="copy-btn" onclick="copyToClipboard('/api/chats/{{ chat.id }}/summary', this)">[cp]</button>
                </div>
                <div class="api-row" style="margin-top: 8px;">
                    <span class="api-method get">GET</span>
                    <code class="api-path">/api/chats/{{ chat.id }}/messages/daily?date=today</code>
                    <button class="dl-btn" onclick="downloadTodayJson({{ chat.id }}, this)">[dl json]</button>
                </div>
            </div>
        </div>

        <div class="chat-actions">
            <button class="summary-btn" onclick="getSummary({{ chat.id }}, this)">
                [ generate summary ]
            </button>
        </div>

        <div class="summary-result" id="summary-{{ chat.id }}">
            <div class="summary-result-header">
                <span class="summary-result-title">ai_summary</span>
                <span class="summary-result-meta" id="summary-meta-{{ chat.id }}"></span>
            </div>
            <div class="summary-result-content" id="summary-content-{{ chat.id }}"></div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <div>-- no chats --</div>
    <div style="margin-top: 8px;">add bot to a group chat to start collecting messages</div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function downloadTodayJson(chatId, button) {
    const today = new Date().toISOString().split('T')[0];
    const url = `/api/chats/${chatId}/messages/daily?date=${today}`;

    const originalText = button.textContent;
    button.textContent = '[...]';

    try {
        const response = await fetch(url);
        const data = await response.json();

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const downloadUrl = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = `chat_${chatId}_${today}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        button.textContent = '[ok]';
        setTimeout(() => button.textContent = originalText, 1000);
    } catch (error) {
        button.textContent = '[err]';
        setTimeout(() => button.textContent = originalText, 1000);
    }
}

async function getSummary(chatId, button) {
    const resultDiv = document.getElementById(`summary-${chatId}`);
    const contentDiv = document.getElementById(`summary-content-${chatId}`);
    const metaDiv = document.getElementById(`summary-meta-${chatId}`);

    const originalText = button.innerHTML;
    button.innerHTML = '<div class="spinner"></div>generating...';
    button.classList.add('loading');
    button.disabled = true;

    resultDiv.classList.remove('visible');

    try {
        const response = await fetch(`/api/chats/${chatId}/summary`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();

        if (data.success) {
            contentDiv.innerHTML = data.summary;
            contentDiv.className = 'summary-result-content';
            metaDiv.textContent = `${data.messages_count} msgs | ${data.period}`;
        } else {
            contentDiv.innerHTML = data.error || 'error occurred';
            contentDiv.className = 'summary-result-content summary-error';
            metaDiv.textContent = '';
        }

        resultDiv.classList.add('visible');

    } catch (error) {
        contentDiv.innerHTML = 'connection error';
        contentDiv.className = 'summary-result-content summary-error';
        metaDiv.textContent = '';
        resultDiv.classList.add('visible');
    } finally {
        button.innerHTML = originalText;
        button.classList.remove('loading');
        button.disabled = false;
    }
}
</script>
{% endblock %}
